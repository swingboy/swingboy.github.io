<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>node require与webpack模块化原理 | swing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="about node require首先： 123//node 模块代码var a = &amp;#123;&amp;#125;;module.exports = a; 问题：在node执行的时候会发现，代码变成了这样子 1234(function (exports, require, module, __filename, __dirname) &amp;#123;    var a = &amp;#123;&amp;#125;;">
<meta name="keywords" content="技术">
<meta property="og:type" content="article">
<meta property="og:title" content="node require与webpack模块化原理">
<meta property="og:url" content="http://swingboy.github.io/2018/06/18/node require与webpack模块化原理/index.html">
<meta property="og:site_name" content="swing">
<meta property="og:description" content="about node require首先： 123//node 模块代码var a = &amp;#123;&amp;#125;;module.exports = a; 问题：在node执行的时候会发现，代码变成了这样子 1234(function (exports, require, module, __filename, __dirname) &amp;#123;    var a = &amp;#123;&amp;#125;;">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-11-23T14:30:35.416Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="node require与webpack模块化原理">
<meta name="twitter:description" content="about node require首先： 123//node 模块代码var a = &amp;#123;&amp;#125;;module.exports = a; 问题：在node执行的时候会发现，代码变成了这样子 1234(function (exports, require, module, __filename, __dirname) &amp;#123;    var a = &amp;#123;&amp;#125;;">
  
    <link rel="alternate" href="/atom.xml" title="swing" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">swing</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://swingboy.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-node require与webpack模块化原理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/18/node require与webpack模块化原理/" class="article-date">
  <time datetime="2018-06-18T13:57:29.000Z" itemprop="datePublished">2018-06-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      node require与webpack模块化原理
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="about-node-require"><a href="#about-node-require" class="headerlink" title="about node require"></a>about node require</h2><p>首先：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//node 模块代码</span><br><span class="line">var a = &#123;&#125;;</span><br><span class="line">module.exports = a;</span><br></pre></td></tr></table></figure>
<p>问题：在node执行的时候会发现，代码变成了这样子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(function (exports, require, module, __filename, __dirname) &#123;</span><br><span class="line">    var a = &#123;&#125;;</span><br><span class="line">    module.exports = a;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到，我们的模块代码在运行的时候是被包裹了一层的，而上面列的这些变量正是在这个包裹函数中作为形参传入的。<br>其中module指向模块本身，module.exports和exports是等价的，表示模块要导出供调用的内容</p>
</blockquote>
<h2 id="require的内部处理流程"><a href="#require的内部处理流程" class="headerlink" title="require的内部处理流程"></a>require的内部处理流程</h2><p>先上<a href="https://github.com/nodejs/node/blob/v5.x/lib/module.js" target="_blank" rel="noopener">代码</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// Loads a module at the given file path. Returns that module&apos;s</span><br><span class="line">// `exports` property.</span><br><span class="line">Module.prototype.require = function (path) &#123;</span><br><span class="line">    assert(path, &apos;missing path&apos;);</span><br><span class="line">    assert(typeof path === &apos;string&apos;, &apos;path must be a string&apos;);</span><br><span class="line">    return Module._load(path, this, /* isMain */ false);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3><p>require命令是CommonJS规范之中，用来加载其他模块的命令。它其实不是一个全局命令，而是指向当前模块的module.require命令，而后者又调用Node的内部命令Module._load。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Module._load = function(request, parent, isMain) &#123;</span><br><span class="line">	// .....</span><br><span class="line">	</span><br><span class="line">	return module.exports;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Module._load = function(request, parent, isMain) &#123;</span><br><span class="line">  // 1. 检查 Module._cache，是否缓存之中有指定模块</span><br><span class="line">  // 2. 如果缓存之中没有，就创建一个新的Module实例</span><br><span class="line">  // 3. 将它保存到缓存</span><br><span class="line">  // 4. 使用 module.load() 加载指定的模块文件，</span><br><span class="line">  //    读取文件内容之后，使用 module.compile() 执行文件代码</span><br><span class="line">  // 5. 如果加载/解析过程报错，就从缓存删除该模块</span><br><span class="line">  // 6. 返回该模块的 module.exports</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// Given a file name, pass it to the proper extension handler.</span><br><span class="line">Module.prototype.load = function(filename) &#123;</span><br><span class="line">  debug(&apos;load %j for module %j&apos;, filename, this.id);</span><br><span class="line"></span><br><span class="line">  assert(!this.loaded);</span><br><span class="line">  this.filename = filename;</span><br><span class="line">  this.paths = Module._nodeModulePaths(path.dirname(filename));</span><br><span class="line">  </span><br><span class="line">  // .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的第4步，采用module.compile()执行指定模块的脚本，逻辑如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// Run the file contents in the correct scope or sandbox. Expose</span><br><span class="line">// the correct helper variables (require, module, exports) to</span><br><span class="line">// the file.</span><br><span class="line">// Returns exception, if any.</span><br><span class="line">Module.prototype._compile = function(content, filename) &#123;</span><br><span class="line">	// .....</span><br><span class="line">	const dirname = path.dirname(filename);</span><br><span class="line">  	const require = internalModule.makeRequireFunction.call(this);</span><br><span class="line">  	const args = [this.exports, require, this, filename, dirname];</span><br><span class="line">  	const depth = internalModule.requireDepth;</span><br><span class="line">  	if (depth === 0) stat.cache = new Map();</span><br><span class="line">  	const result = compiledWrapper.apply(this.exports, args);</span><br><span class="line">  	if (depth === 0) stat.cache = null;</span><br><span class="line">  	return result;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Module.prototype._compile = function(content, filename) &#123;</span><br><span class="line">  // 1. 生成一个require函数，指向module.require</span><br><span class="line">  // 2. 加载其他辅助方法到require</span><br><span class="line">  // 3. 将文件内容放到一个函数之中，该函数可调用 require</span><br><span class="line">  // 4. 执行该函数</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上面的第1步和第2步，require函数及其辅助方法主要如下。</p>
<blockquote>
<p>require(): 加载外部模块<br>require.resolve()：将模块名解析到一个绝对路径<br>require.cache：指向所有缓存的模块<br>require.extensions：根据文件的后缀名，调用不同的执行函数  </p>
</blockquote>
<p>一旦require函数准备完毕，整个所要加载的脚本内容，就被放到一个新的函数之中，这样可以避免污染全局环境。该函数的参数包括require、module、exports，以及其他一些参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(function (exports, require, module, __filename, __dirname) &#123;</span><br><span class="line">  // YOUR CODE INJECTED HERE!</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Module._compile方法是同步执行的，所以Module._load要等它执行完成，才会向用户返回module.exports的值。</p>
<p>在Module._complie中是会在我们模块的代码外面包裹一些内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Module.prototype._compile = function(content, filename) &#123;</span><br><span class="line">  // remove shebang</span><br><span class="line">  content = content.replace(shebangRe, &apos;&apos;);</span><br><span class="line"></span><br><span class="line">  // create wrapper function</span><br><span class="line">  var wrapper = Module.wrap(content);</span><br><span class="line"></span><br><span class="line">  var compiledWrapper = runInThisContext(wrapper,</span><br><span class="line">                                      &#123; filename: filename, lineOffset: 0 &#125;);</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//Module的warp 来自NativeModule</span><br><span class="line"></span><br><span class="line">NativeModule.wrap = function(script) &#123;</span><br><span class="line">  return NativeModule.wrapper[0] + script + NativeModule.wrapper[1];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">NativeModule.wrapper = [</span><br><span class="line">  &apos;(function (exports, require, module, __filename, __dirname) &#123; &apos;,</span><br><span class="line">  &apos;\n&#125;);&apos;</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>自此我们的模块内容算是包装完了。</p>
<p>AND <del>~</del>~</p>
<p>我们可以模拟一个类似node require的办法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">function require(path) &#123;</span><br><span class="line">    function load()&#123;</span><br><span class="line">        return &apos;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line">    let code = load(path);</span><br><span class="line">    code = &apos;function add(a, b) &#123;return a+b&#125;; module.exports = add&apos;;</span><br><span class="line">    // 封装成闭包</span><br><span class="line">    code = `(function(module) &#123; $&#123;code&#125; &#125;)(context)`;</span><br><span class="line">    // 相当于 exports，用于导出对象</span><br><span class="line">    let context = &#123;&#125;;</span><br><span class="line">    // 运行代码，使得结果影响到 context</span><br><span class="line">    const run = new Function(&apos;context&apos;, code);</span><br><span class="line">    </span><br><span class="line">    //大概就是这样子</span><br><span class="line">    &lt;!-- function(context)&#123;</span><br><span class="line">        (function(module) &#123;</span><br><span class="line">            function add(a, b) &#123;return a+b&#125;; </span><br><span class="line">            module.exports = add;</span><br><span class="line">        &#125;)(context)</span><br><span class="line">    &#125; --&gt;</span><br><span class="line"></span><br><span class="line">    run(context, code);</span><br><span class="line">    </span><br><span class="line">    //返回导出的结果</span><br><span class="line">    return context.exports;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var a = require(&apos;xxx&apos;).exports;</span><br></pre></td></tr></table></figure>
<p><a href="http://www.ruanyifeng.com/blog/2015/05/require.html" target="_blank" rel="noopener">阮老师require</a></p>
<h2 id="about-webpack-模块化"><a href="#about-webpack-模块化" class="headerlink" title="about webpack 模块化"></a>about webpack 模块化</h2><h5 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h5><p>webpack作为一个构建工具，解决了前端代码缺少模块化能力的问题。代码经过webpack构建和包装之后，能够在浏览器以模块化的方式运行。这些能力，都是因为webpack对我们的代码进行了一层包装。</p>
<h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>首先我们创建一个简单入口模块index.js和一些依赖模块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//index.js</span><br><span class="line">let &#123;name, age, address&#125; = require(&apos;./common.js&apos;);</span><br><span class="line">import es6 from &apos;./es6.js&apos;;</span><br><span class="line"></span><br><span class="line">console.log(name, es6(10));</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//es6.js</span><br><span class="line">export default function(a)&#123;</span><br><span class="line">	return 1000 + a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function testfun(a)&#123;</span><br><span class="line">	return a + &apos;哈哈哈&apos;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//common.js</span><br><span class="line">module.exports = &#123;</span><br><span class="line">	age: 10,</span><br><span class="line">	name: &apos;zhangsan&apos;,</span><br><span class="line">	address: function()&#123;</span><br><span class="line">		return &apos;dddd&apos;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>webpack 配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var path = require(&quot;path&quot;);</span><br><span class="line">module.exports = &#123;</span><br><span class="line">    entry: path.join(__dirname, &apos;index.js&apos;),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.join(__dirname, &apos;outs&apos;),</span><br><span class="line">        filename: &apos;index.js&apos;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这是一个最简单的配置，只指定了模块入口和输出路径。</p>
</blockquote>
<p>执行webpack，得到经过webpack打包的代码如下（去掉了不必要的注释）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">/******/ (function(modules) &#123; // webpackBootstrap</span><br><span class="line">/******/ 	// The module cache</span><br><span class="line">/******/ 	var installedModules = &#123;&#125;;</span><br><span class="line">/******/ 	// The require function</span><br><span class="line">/******/ 	function __webpack_require__(moduleId) &#123;</span><br><span class="line">/******/ 		// Check if module is in cache</span><br><span class="line">/******/ 		if(installedModules[moduleId]) &#123;</span><br><span class="line">/******/ 			return installedModules[moduleId].exports;</span><br><span class="line">/******/ 		&#125;</span><br><span class="line">/******/ 		// Create a new module (and put it into the cache)</span><br><span class="line">/******/ 		var module = installedModules[moduleId] = &#123;</span><br><span class="line">/******/ 			i: moduleId,</span><br><span class="line">/******/ 			l: false,</span><br><span class="line">/******/ 			exports: &#123;&#125;</span><br><span class="line">/******/ 		&#125;;</span><br><span class="line">/******/ 		// Execute the module function</span><br><span class="line">/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);</span><br><span class="line">/******/ 		// Flag the module as loaded</span><br><span class="line">/******/ 		module.l = true;</span><br><span class="line">/******/ 		// Return the exports of the module</span><br><span class="line">/******/ 		return module.exports;</span><br><span class="line">/******/ 	&#125;</span><br><span class="line">/******/ 	// expose the modules object (__webpack_modules__)</span><br><span class="line">/******/ 	__webpack_require__.m = modules;</span><br><span class="line">/******/</span><br><span class="line">/******/ 	// expose the module cache</span><br><span class="line">/******/ 	__webpack_require__.c = installedModules;</span><br><span class="line">/******/</span><br><span class="line">/******/ 	// define getter function for harmony exports</span><br><span class="line">/******/ 	__webpack_require__.d = function(exports, name, getter) &#123;</span><br><span class="line">/******/ 		if(!__webpack_require__.o(exports, name)) &#123;</span><br><span class="line">/******/ 			Object.defineProperty(exports, name, &#123; enumerable: true, get: getter &#125;);</span><br><span class="line">/******/ 		&#125;</span><br><span class="line">/******/ 	&#125;;</span><br><span class="line">/******/ 	// define __esModule on exports</span><br><span class="line">/******/ 	__webpack_require__.r = function(exports) &#123;</span><br><span class="line">/******/ 		if(typeof Symbol !== &apos;undefined&apos; &amp;&amp; Symbol.toStringTag) &#123;</span><br><span class="line">/******/ 			Object.defineProperty(exports, Symbol.toStringTag, &#123; value: &apos;Module&apos; &#125;);</span><br><span class="line">/******/ 		&#125;</span><br><span class="line">/******/ 		Object.defineProperty(exports, &apos;__esModule&apos;, &#123; value: true &#125;);</span><br><span class="line">/******/ 	&#125;;</span><br><span class="line">/******/ 	__webpack_require__.t = function(value, mode) &#123;</span><br><span class="line">/******/ 		if(mode &amp; 1) value = __webpack_require__(value);</span><br><span class="line">/******/ 		if(mode &amp; 8) return value;</span><br><span class="line">/******/ 		if((mode &amp; 4) &amp;&amp; typeof value === &apos;object&apos; &amp;&amp; value &amp;&amp; value.__esModule) return value;</span><br><span class="line">/******/ 		var ns = Object.create(null);</span><br><span class="line">/******/ 		__webpack_require__.r(ns);</span><br><span class="line">/******/ 		Object.defineProperty(ns, &apos;default&apos;, &#123; enumerable: true, value: value &#125;);</span><br><span class="line">/******/ 		if(mode &amp; 2 &amp;&amp; typeof value != &apos;string&apos;) for(var key in value) __webpack_require__.d(ns, key, function(key) &#123; return value[key]; &#125;.bind(null, key));</span><br><span class="line">/******/ 		return ns;</span><br><span class="line">/******/ 	&#125;;</span><br><span class="line">/******/</span><br><span class="line">/******/ 	// getDefaultExport function for compatibility with non-harmony modules</span><br><span class="line">/******/ 	__webpack_require__.n = function(module) &#123;</span><br><span class="line">/******/ 		var getter = module &amp;&amp; module.__esModule ?</span><br><span class="line">/******/ 			function getDefault() &#123; return module[&apos;default&apos;]; &#125; :</span><br><span class="line">/******/ 			function getModuleExports() &#123; return module; &#125;;</span><br><span class="line">/******/ 		__webpack_require__.d(getter, &apos;a&apos;, getter);</span><br><span class="line">/******/ 		return getter;</span><br><span class="line">/******/ 	&#125;;</span><br><span class="line">/******/</span><br><span class="line">/******/ 	// Object.prototype.hasOwnProperty.call</span><br><span class="line">/******/ 	__webpack_require__.o = function(object, property) &#123; return Object.prototype.hasOwnProperty.call(object, property); &#125;;</span><br><span class="line">/******/</span><br><span class="line">/******/ 	// __webpack_public_path__</span><br><span class="line">/******/ 	__webpack_require__.p = &quot;&quot;;</span><br><span class="line">/******/</span><br><span class="line">/******/</span><br><span class="line">/******/ 	// Load entry module and return exports</span><br><span class="line">/******/ 	return __webpack_require__(__webpack_require__.s = &quot;./src/index.js&quot;);</span><br><span class="line">/******/ &#125;)</span><br><span class="line">/******/ (&#123;</span><br><span class="line"></span><br><span class="line">/***/ &quot;./src/common.js&quot;:</span><br><span class="line">/***/ (function(module, exports) &#123;</span><br><span class="line"></span><br><span class="line">  eval(&quot;module.exports = &#123;\n\tage: 10,\n\tname: &apos;zhangsan&apos;,\n\taddress: function()&#123;\n\t\treturn &apos;dddd&apos;\n\t&#125;\n&#125;\n\n//# sourceURL=webpack:///./src/common.js?&quot;);</span><br><span class="line">  /***/ &#125;),</span><br><span class="line">  </span><br><span class="line">  /***/ &quot;./src/es6.js&quot;:</span><br><span class="line">  /***/ (function(module, __webpack_exports__, __webpack_require__) &#123;</span><br><span class="line">  </span><br><span class="line">  &quot;use strict&quot;;</span><br><span class="line">  eval(&quot;__webpack_require__.r(__webpack_exports__);\n/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, \&quot;testfun\&quot;, function() &#123; return testfun; &#125;);\n/* harmony default export */ __webpack_exports__[\&quot;default\&quot;] = (function(a)&#123;\n\treturn 1000 + a;\n&#125;);\n\nfunction testfun(a)&#123;\n\treturn a + &apos;哈哈哈&apos;;\n&#125;\n\n//# sourceURL=webpack:///./src/es6.js?&quot;);</span><br><span class="line">  /***/ &#125;),</span><br><span class="line"></span><br><span class="line">  /***/ &quot;./src/index.js&quot;:</span><br><span class="line">  /***/ (function(module, __webpack_exports__, __webpack_require__) &#123;  </span><br><span class="line">  &quot;use strict&quot;;</span><br><span class="line">  eval(&quot;__webpack_require__.r(__webpack_exports__);\n/* harmony import */ var _es6_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./es6.js */ \&quot;./src/es6.js\&quot;);\nlet &#123;name, age, address&#125; = __webpack_require__(/*! ./common.js */ \&quot;./src/common.js\&quot;);\n\n\nconsole.log(name, Object(_es6_js__WEBPACK_IMPORTED_MODULE_0__[\&quot;default\&quot;])(10));\n\n\n//# sourceURL=webpack:///./src/index.js?&quot;);</span><br><span class="line"></span><br><span class="line">  /***/ &#125;)</span><br><span class="line"></span><br><span class="line">  /******/ &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>上面webpack打包的代码，整体可以简化成下面的结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(function (modules) &#123;/* xxxx */&#125;)</span><br><span class="line">(&#123;</span><br><span class="line">    &apos;./src/common.js&apos;: (function(module, exports) &#123;</span><br><span class="line">                /* 模块common.js的代码 */</span><br><span class="line">                eval(&quot;module.exports = &#123;\n\tage: 10,\n\tname: &apos;zhangsan&apos;,\n\taddress: function()&#123;\n\t\treturn &apos;dddd&apos;\n\t&#125;\n&#125;\n\n//# sourceURL=webpack:///./src/common.js?&quot;);</span><br><span class="line">                &#125;),</span><br><span class="line">    &apos;./src/es6.js&apos;: f()&#123;&#125;, /* 模块es6.js的代码 */</span><br><span class="line">    &apos;./src/index.js&apos;: f()&#123;&#125;, /* 模块index.js的代码 */</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>入口处文件最后结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var str = `__webpack_require__.r(__webpack_exports__);</span><br><span class="line">var _es6_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(\&quot;./src/es6.js\&quot;);</span><br><span class="line">var &#123;name, age, address&#125; = __webpack_require__(\&quot;./src/common.js\&quot;);</span><br><span class="line">console.log(name, Object(_es6_js__WEBPACK_IMPORTED_MODULE_0__[\&quot;default\&quot;])(10));`;</span><br><span class="line">eval(str);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到，整个打包生成的代码是一个立即执行函数。</p>
</blockquote>
<p>首先：函数参数是我们写的各个模块组成的数组，只不过我们的代码，被webpack包装在了一个函数的内部（也就是说我们的模块），在这里就是一个函数。为什么要这样做，是因为浏览器本身不支持模块化，那么webpack就用函数作用域来hack模块化的效果。</p>
<p>如果你debug过node代码，你会发现一样的hack方式，node中的模块也是函数，跟模块相关的参数exports、require，或者其他参数<strong>filename和</strong>dirname等都是通过函数传值作为模块中的变量，模块与外部模块的访问就是通过这些参数进行的，当然这对开发者来说是透明的。</p>
<p>同样的方式，webpack也控制了模块的module、exports和require，那么我们就看看webpack是如何实现这些功能的。</p>
<p>下面是摘取的函数内容和一些注释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// 1、模块缓存对象</span><br><span class="line">var installedModules = &#123;&#125;;</span><br><span class="line">// 2、webpack实现的require</span><br><span class="line">function __webpack_require__(moduleId) &#123;</span><br><span class="line">    // 3、判断是否已缓存模块</span><br><span class="line">    if(installedModules[moduleId]) &#123;</span><br><span class="line">        return installedModules[moduleId].exports;</span><br><span class="line">    &#125;</span><br><span class="line">    // 4、缓存模块</span><br><span class="line">    var module = installedModules[moduleId] = &#123;</span><br><span class="line">        i: moduleId,</span><br><span class="line">        l: false,</span><br><span class="line">        exports: &#123;&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    // 5、调用模块函数</span><br><span class="line">    modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);</span><br><span class="line">    // 6、标记模块为已加载</span><br><span class="line">    module.l = true;</span><br><span class="line">    // 7、返回module.exports</span><br><span class="line">    return module.exports;</span><br><span class="line">&#125;</span><br><span class="line">// 8、require第一个模块</span><br><span class="line">return __webpack_require__(__webpack_require__.s = 0);</span><br></pre></td></tr></table></figure>
<p>webpack之前的版本打过的内容，是这样子的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(function(module) &#123;</span><br><span class="line">&#125;)([(function ()&#123;&#125;), function() &#123;&#125;])</span><br></pre></td></tr></table></figure>
<blockquote>
<p>模块数组作为参数传入IIFE函数后，IIFE做了一些初始化工作：<br>IIFE首先定义了installedModules ，这个变量被用来缓存已加载的模块。</p>
</blockquote>
<blockquote>
<p>定义了<strong>webpack_require</strong> 这个函数，函数参数为模块的id。这个函数用来实现模块的require。</p>
</blockquote>
<blockquote>
<p><strong>webpack_require</strong> 函数首先会检查是否缓存了已加载的模块，如果有则直接返回缓存模块的exports。如果没有缓存，也就是第一次加载，则首先初始化模块，并将模块进行缓存。</p>
</blockquote>
<blockquote>
<p>然后调用模块函数，也就是前面webpack对我们的模块的包装函数，将module、module.exports和<strong>webpack_require</strong>作为参数传入。注意这里做了一个动态绑定，将模块函数的调用对象绑定module.exports，这是为了保证在模块中的this指向当前模块。</p>
</blockquote>
<blockquote>
<p>调用完成后，模块标记为已加载。</p>
</blockquote>
<blockquote>
<p>返回模块exports的内容。</p>
</blockquote>
<blockquote>
<p>利用前面定义的<strong>webpack_require</strong> 函数，require第0个模块，也就是入口模块。</p>
</blockquote>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>打包过的模块生成了一些以自执行函数形式的闭包。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://swingboy.github.io/2018/06/18/node require与webpack模块化原理/" data-id="cjv3rsv1x000n0njfohzgqfru" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/技术/">技术</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/07/14/关于js模块化/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          关于js模块化
        
      </div>
    </a>
  
  
    <a href="/2018/06/15/前端异常监控详聊/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">前端异常监控详聊</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/技术/">技术</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/随笔/">随笔</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/技术/" style="font-size: 20px;">技术</a> <a href="/tags/随笔/" style="font-size: 10px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/04/30/about hexo/">about hexo</a>
          </li>
        
          <li>
            <a href="/2019/03/29/webpack原理/">webpack原理</a>
          </li>
        
          <li>
            <a href="/2019/03/29/webpackPlugin/">webpackPlugin</a>
          </li>
        
          <li>
            <a href="/2019/03/29/webpackLoader/">webpackLoader</a>
          </li>
        
          <li>
            <a href="/2019/03/29/about-tapable/">about tapable</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 火柴人<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>